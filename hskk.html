<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>HSK 4 ‚Äî Cards (mobile, lazy strokes, fast TTS)</title>
<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5.2/dist/hanzi-writer.min.js"></script>
<style>
  :root{--pad:14px; --card:16px; --tile:160px; --gap:10px}
  body{margin:0;background:#fafafa;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans SC','Noto Sans',sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:var(--pad);z-index:10}
  h1{margin:0 0 8px;font-size:18px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  input[type="search"],select,button{padding:12px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;font-size:17px;min-height:44px}

  .alpha{display:flex;gap:6px;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;padding-bottom:6px}
  .alpha::-webkit-scrollbar{display:none}
  .alpha button{flex:0 0 auto;min-width:44px;min-height:40px;border-radius:10px;border:1px solid #ddd;background:#fff}
  .alpha button.active{background:#111;color:#fff}

  main{padding:var(--pad)}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{background:#fff;border:1px solid #eee;border-radius:18px;padding:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .c-top{display:flex;flex-direction:column;align-items:center;gap:4px;margin-bottom:8px}
  .zz{font-size:40px;line-height:1}
  .tt{font-size:26px;color:#666}

  /* stroke grid (‡∏Å‡∏•‡∏≤‡∏á + ‡πÇ‡∏õ‡∏£‡πà‡∏á) */
  .writers-wrap{
    margin:24px auto 18px;
    display:flex;justify-content:center;
    width:var(--tile); /* ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏î‡∏¢ JS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ 3 ‡∏ï‡∏±‡∏ß */
  }
  .writers{
    display:grid;grid-gap:var(--gap);
    justify-items:center;align-items:center;row-gap:20px;
  }
  .writer{
    display:flex;align-items:center;justify-content:center;
    width:100%;aspect-ratio:1/1;
    border-radius:10px;border:1px solid #e5e5e5;background:#f7fbff;
    cursor:pointer;touch-action:manipulation;
    transition:transform .06s ease, filter .06s ease, box-shadow .06s ease;
  }
  .writer:active,.writer.pressed{transform:scale(.96);filter:brightness(.96);box-shadow:inset 0 0 0 2px rgba(0,0,0,.06)}
  .writer.fallback{background:#fff}
  /* fallback glyph size will follow --cell (set by JS) */
  .writer.fallback{font-size:calc(var(--cell, 80px) * 0.66);color:#222}

  .pinyin-row{display:flex;gap:8px;align-items:center;justify-content:center;margin:6px 0}
  .play-main{display:inline-flex;align-items:center;gap:8px;border:1px solid #ddd;background:#fff;border-radius:999px;padding:8px 14px;min-height:auto;font-size:16px}
  .play-main::before{content:'üîä'}
  .pinyin-text{font-size:18px}

  .meaning{margin-top:8px;color:#333;font-size:16px;text-align:center}
  .badge{font-size:12px;color:#666}
  details{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px}
  textarea{width:100%;min-height:160px;border:1px solid #ddd;border-radius:12px;padding:10px;font-size:15px}
  .muted{color:#666;font-size:12px}

  @media (max-width:640px){
    header{position:static;padding-bottom:8px}
    .zz{font-size:34px}.tt{font-size:22px}
    :root{--tile:140px}
  }
</style>
</head>
<body>
<header>
  <h1>HSK 4 ‚Äî ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚úçÔ∏èüîä</h1>
  <div class="row" style="margin-bottom:8px">
    <label>Dataset: <select id="dataset"></select></label>
    <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏à‡∏µ‡∏ô / pinyin / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‚Ä¶" />
  </div>
  <div class="alpha" id="alphaBar"></div>
  <div class="row" style="margin-top:8px">
    <label>‡πÄ‡∏™‡∏µ‡∏¢‡∏á (zh-CN): <select id="voice"></select></label>
    <span class="badge" id="count"></span>
  </div>
</header>

<main>
  <details id="importBox" open>
    <summary><b>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î‡πÑ‡∏î‡πâ)</b></summary>
    <div class="row" style="margin:10px 0">
      <input id="file" type="file" accept=".txt,.tsv,.csv" />
      <input id="dsNameFile" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô HSK4 ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå A)" />
      <button id="loadFile" type="button">Import .txt</button>
    </div>
    <p class="muted">‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á (Paste) ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå .txt ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Save (‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô --- ‡∏Å‡πá‡πÑ‡∏î‡πâ)</p>
    <input id="dsNamePaste" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô HSK4 ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô B)" style="margin-bottom:8px;width:100%;box-sizing:border-box" />
    <textarea id="pasteArea" placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HSK-Hanzi-L4.txt ‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="savePaste" type="button">Save</button>
      <button id="deleteDataset" type="button" style="margin-left:auto">‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <span class="badge" id="status"></span>
    </div>
  </details>

  <div id="cards" class="cards"></div>
</main>

<script>
/* ===== DOM & storage keys ===== */
const LSK_INDEX='hsk4_multi_index_v3';
const LSK_DATA_PREFIX='hsk4_multi_data_v3:';
const LSK_LAST='hsk4_last_selected_v3';
const datasetSel=document.getElementById('dataset');
const q=document.getElementById('q'), alphaBar=document.getElementById('alphaBar');
const voiceSel=document.getElementById('voice'), count=document.getElementById('count');
const cardsEl=document.getElementById('cards');
const fileInput=document.getElementById('file'), loadFileBtn=document.getElementById('loadFile');
const dsNameFile=document.getElementById('dsNameFile'), pasteArea=document.getElementById('pasteArea');
const savePasteBtn=document.getElementById('savePaste'), dsNamePaste=document.getElementById('dsNamePaste');
const deleteBtn=document.getElementById('deleteDataset'); const statusSpan=document.getElementById('status');
function setStatus(m){statusSpan.textContent=m||''}

/* ===== pinyin & initials ===== */
const toneMap={'ƒÅ':'a','√°':'a','«é':'a','√†':'a','ƒì':'e','√©':'e','ƒõ':'e','√®':'e','ƒ´':'i','√≠':'i','«ê':'i','√¨':'i','≈ç':'o','√≥':'o','«í':'o','√≤':'o','≈´':'u','√∫':'u','«î':'u','√π':'u','«ñ':'v','«ò':'v','«ö':'v','«ú':'v','√º':'v'};
function deTone(s){return (s||'').replace(/[ƒÅ√°«é√†ƒì√©ƒõ√®ƒ´√≠«ê√¨≈ç√≥«í√≤≈´√∫«î√π«ñ«ò«ö«ú√º]/g,c=>toneMap[c]||c)}
const INITIALS=['A','O','E','I','U','√ú','B','P','M','F','D','T','N','L','G','K','H','J','Q','X','Zh','Ch','Sh','R','Z','C','S','Y','W'];
function pinyinInitial(p){
  const s=deTone((p||'').toLowerCase()).replace(/[^a-z√ºv]/g,'');
  if(!s) return '#';
  if(s.startsWith('zh')) return 'Zh';
  if(s.startsWith('ch')) return 'Ch';
  if(s.startsWith('sh')) return 'Sh';
  const ch=s[0];
  if('aoeiu'.includes(ch)) return ch.toUpperCase();
  if(ch==='v'||ch==='√º') return '√ú';
  if(ch==='y') return 'Y';
  if(ch==='w') return 'W';
  return ch.toUpperCase();
}

/* ===== Voices (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏µ‡∏ô‡∏à‡∏£‡∏¥‡∏á: ‡∏û‡∏π‡∏î‡∏ï‡∏±‡∏ß‡∏à‡∏µ‡∏ô) ===== */
function loadVoices(){
  if(!('speechSynthesis'in window))return;
  const vs=speechSynthesis.getVoices().filter(v=>(v.lang||'').toLowerCase().startsWith('zh'));
  voiceSel.innerHTML=''; vs.forEach(v=>{const o=document.createElement('option');o.value=v.name;o.textContent=v.name+' ('+v.lang+')';voiceSel.appendChild(o)});
  const saved=localStorage.getItem('hsk4_voice'); if(saved && Array.from(voiceSel.options).some(o=>o.value===saved)) voiceSel.value=saved;
}
function getVoice(){const name=voiceSel.value;return speechSynthesis.getVoices().find(v=>v.name===name)||null}
let ttsReady = false;
function warmTTS(){
  if (ttsReady || !('speechSynthesis' in window)) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance('„ÄÇ');
    u.lang = 'zh-CN'; u.volume = 0; const v=getVoice(); if(v) u.voice=v; u.rate=1.0;
    speechSynthesis.speak(u);
    setTimeout(()=> speechSynthesis.cancel(), 60);
    ttsReady = true;
  }catch{}
}
window.addEventListener('touchstart', warmTTS, { once:true, passive:true });
window.addEventListener('mousedown' , warmTTS, { once:true });

function speak(text){
  if (!('speechSynthesis' in window)) { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î'); return; }
  warmTTS();
  try{
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text||'');
    u.lang='zh-CN'; const v=getVoice(); if(v) u.voice=v; u.rate=1.0; u.pitch=1.0;
    speechSynthesis.speak(u);
  }catch(e){ console.error(e); }
}
if('speechSynthesis'in window){loadVoices(); speechSynthesis.onvoiceschanged=loadVoices}
voiceSel.addEventListener('change',()=>localStorage.setItem('hsk4_voice',voiceSel.value))

/* ===== parser ===== */
function parseHSK(text){
  const lines=(text||'').split(/\r?\n/); let started=false; const out=[];
  for(const raw of lines){
    const s=(raw||'').trim(); if(!s) continue;
    if(!started){
      if(/^-{3,}/.test(s)){ started=true; continue; }
      const parts=s.split('\t'); if(parts.length>=5 && /[\p{Script=Han}]/u.test(parts[0])) started=true; else continue;
    }
    const parts=s.split('\t'); if(parts.length<5) continue;
    const simp=(parts[0]||'').trim(), trad=(parts[1]||'').trim();
    const pinyinNum=(parts[2]||'').trim();
    const pinyin=((parts[3]||'').trim()||pinyinNum).replace(/\s+/g,' ').trim();
    let meaning=(parts[4]||'').trim();
    meaning=(meaning.split(/CL:|\[[^\]]*\]|abbr\./i)[0]||meaning).replace(/^[\s,;‚Äî‚Äì-]+|[\s,;‚Äî‚Äì-]+$/g,'');
    if(!simp) continue;
    out.push({simp,trad,pinyin,meaning,alpha:pinyinInitial(pinyin)});
  }
  const order=new Map(INITIALS.map((v,i)=>[v,i]));
  out.sort((a,b)=> (order.get(a.alpha)??999)-(order.get(b.alpha)??999)
    || deTone(a.pinyin).localeCompare(deTone(b.pinyin))
    || a.meaning.localeCompare(b.meaning));
  return out;
}

/* ===== dataset storage ===== */
function loadIndex(){try{return JSON.parse(localStorage.getItem(LSK_INDEX)||'[]')}catch{return []}}
function saveIndex(arr){localStorage.setItem(LSK_INDEX,JSON.stringify(arr))}
function slugify(s){return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,64)||('ds-'+Date.now())}
function dsKey(title){const base=slugify(title);const idx=loadIndex();let k=base,n=1;while(idx.some(x=>x.key===k)){k=base+'-'+(++n)}return k}
function saveDataset(title,rows){const idx=loadIndex();const key=dsKey(title);idx.push({key,title});saveIndex(idx);localStorage.setItem(LSK_DATA_PREFIX+key,JSON.stringify(rows||[]));return key}
function loadDataset(key){try{return JSON.parse(localStorage.getItem(LSK_DATA_PREFIX+key)||'[]')}catch{return []}}
function deleteDatasetByKey(key){saveIndex(loadIndex().filter(x=>x.key!==key));localStorage.removeItem(LSK_DATA_PREFIX+key)}
function refreshDatasetSelect(selectKey){
  const idx=loadIndex(); datasetSel.innerHTML='';
  idx.forEach(d=>{const o=document.createElement('option');o.value=d.key;o.textContent=d.title;datasetSel.appendChild(o)});
  if(selectKey && idx.some(x=>x.key===selectKey)) datasetSel.value=selectKey;
}

/* ===== Initials (pinyin bar) ===== */
const INITIALS_UI=['A','O','E','I','U','√ú','B','P','M','F','D','T','N','L','G','K','H','J','Q','X','Zh','Ch','Sh','R','Z','C','S','Y','W'];
let currentInitial='';
INITIALS_UI.forEach(L=>{
  const b=document.createElement('button'); b.textContent=L;
  b.addEventListener('click',()=>{
    document.querySelectorAll('.alpha button').forEach(x=>x.classList.remove('active'));
    if(currentInitial===L){ currentInitial=''; render(); return; }
    currentInitial=L; b.classList.add('active'); render();
  });
  alphaBar.appendChild(b);
});

/* ===== Hanzi Writer data cache ===== */
function getCharDataCache(){try{return JSON.parse(localStorage.getItem('hanzi_char_json_cache')||'{}')}catch{return {}}}
function setCharDataCache(obj){localStorage.setItem('hanzi_char_json_cache',JSON.stringify(obj||{}))}
async function loadCharJSON(ch){
  const cache=getCharDataCache(); if(cache[ch]) return cache[ch];
  const urls=[
    `https://cdn.jsdelivr.net/npm/hanzi-writer-data@latest/${encodeURIComponent(ch)}.json`,
    `https://unpkg.com/hanzi-writer-data@latest/${encodeURIComponent(ch)}.json`,
    `https://cdnjs.cloudflare.com/ajax/libs/hanzi-writer-data/2.0.0/${encodeURIComponent(ch)}.json`
  ];
  for(const u of urls){
    try{ const r=await fetch(u,{cache:'force-cache'}); if(r.ok){ const j=await r.json(); cache[ch]=j; setCharDataCache(cache); return j; } }
    catch(e){}
  }
  throw new Error('no char data');
}

/* ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á writer ‡πÅ‡∏ö‡∏ö ‚Äú‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‚Äù ===== */
async function initOneWriter(el){
  const char = el.dataset.char;
  if(!char || el.dataset.inited) return;
  el.dataset.inited = '1';
  try{
    const data = await loadCharJSON(char);
    const pad = 10; // ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà: ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    HanziWriter.create(el, char, {
      width: el.clientWidth||100, height: el.clientHeight||100, padding: pad,
      showCharacter:false, showOutline:true,
      strokeAnimationSpeed:1, delayBetweenStrokes:200,
      charDataLoader: ()=>Promise.resolve(data)
    });
  }catch{
    el.classList.add('fallback'); el.textContent = char;
  }
  // touch‚Üí‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏•‡∏∑‡πà‡∏ô)
  el.addEventListener('pointerdown', ()=> el.classList.add('pressed'));
  ['pointerup','pointercancel','pointerleave'].forEach(ev=> el.addEventListener(ev, ()=> el.classList.remove('pressed')));
  el.addEventListener('click', ()=> speak(char), {passive:true});
}

const tileObserver = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting){ initOneWriter(e.target); tileObserver.unobserve(e.target); }
  });
},{rootMargin:'200px 0px', threshold:0.1});

/* ===== layout (‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏ö‡∏ö 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏™‡∏°‡∏≠ + 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ===== */
function layoutWritersGrid(container, count){
  const root = getComputedStyle(document.documentElement);
  const tile = parseFloat(root.getPropertyValue('--tile')) || 160;
  const gap  = parseFloat(root.getPropertyValue('--gap'))  || 10;

  const cell = Math.floor((tile - gap) / 2);  // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö 2 ‡∏ï‡∏±‡∏ß
  container.style.setProperty('--cell', cell + 'px');

  // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  let cols = 2, wrapWidth = tile;
  if (count === 3){
    cols = 3;
    wrapWidth = cell * 3 + gap * 2; // ‡∏Ç‡∏¢‡∏≤‡∏¢ wrap ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ 3 ‡∏ä‡πà‡∏≠‡∏á
  }

  container.style.display='grid';
  container.style.gridTemplateColumns = `repeat(${cols}, ${cell}px)`;
  container.style.justifyContent='center';
  container.style.justifyItems='center';
  container.style.alignItems='center';
  container.style.rowGap='20px';

  const wrap = container.parentElement;
  if (wrap){ wrap.style.width = wrapWidth + 'px'; wrap.style.marginLeft='auto'; wrap.style.marginRight='auto'; }

  Array.from(container.children).forEach(c=>{
    c.style.width = cell+'px';
    c.style.height = cell+'px';
    c.style.gridColumn = '';
    c.style.margin = '';
  });

  if (count === 1 && container.firstElementChild){
    container.firstElementChild.style.gridColumn = `1 / span ${cols}`;
    container.firstElementChild.style.margin = '0 auto';
  }
}

/* ===== render (‡πÄ‡∏ö‡∏≤: ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î stroke ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô) ===== */
let CURRENT=[], VISIBLE=0, PAGE=48; // ‡πÇ‡∏ä‡∏ß‡πå 48 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô
function render(){
  // filter
  let list=CURRENT;
  const term=(q.value||'').toLowerCase().trim();
  if(term){
    list=list.filter(r =>
      r.meaning.toLowerCase().includes(term) ||
      deTone(r.pinyin).toLowerCase().includes(term) ||
      (r.simp + r.trad).includes(term)
    );
  }
  if(currentInitial) list=list.filter(r=>r.alpha===currentInitial);
  count.textContent=list.length+' / '+CURRENT.length+' items';

  // virtualize
  VISIBLE = Math.min(list.length, PAGE);
  cardsEl.innerHTML='';
  const frag=document.createDocumentFragment();
  for(let i=0;i<VISIBLE;i++){
    const row=list[i];
    const card=document.createElement('div'); card.className='card';
    const chars=(row.simp||'').split('').filter(c=>/\p{Script=Han}/u.test(c));
    card.innerHTML=`
      <div class="c-top">
        <div class="zz">${row.simp}</div>
        <div class="tt">${row.trad}</div>
      </div>
      <div class="writers-wrap"><div class="writers"></div></div>
      <div class="pinyin-row">
        <button class="play-main" type="button" data-text="${row.simp}">
          <span class="pinyin-text">${row.pinyin}</span>
        </button>
      </div>
      <div class="meaning">${row.meaning}</div>`;
    const grid=card.querySelector('.writers');
    grid.innerHTML = chars.map(ch=>`<div class="writer" data-char="${ch}" role="button" aria-label="tap"></div>`).join('');
    layoutWritersGrid(grid, chars.length); // ‡∏ß‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    frag.appendChild(card);
  }
  cardsEl.appendChild(frag);

  // bind audio (‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥)
  cardsEl.querySelectorAll('.play-main').forEach(btn=>{
    btn.addEventListener('click', e=> speak(e.currentTarget.dataset.text));
  });

  // observe tiles (lazy init)
  cardsEl.querySelectorAll('.writer').forEach(tile=> tileObserver.observe(tile));

  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏™‡∏∏‡∏î
  window.onscroll = () => {
    const nearBottom = (window.innerHeight + window.scrollY) > (document.body.offsetHeight - 600);
    if(nearBottom && VISIBLE < list.length){
      const end = Math.min(list.length, VISIBLE + PAGE);
      const frag2=document.createDocumentFragment();
      for(let i=VISIBLE;i<end;i++){
        const row=list[i];
        const card=document.createElement('div'); card.className='card';
        const chars=(row.simp||'').split('').filter(c=>/\p{Script=Han}/u.test(c));
        card.innerHTML=`
          <div class="c-top">
            <div class="zz">${row.simp}</div>
            <div class="tt">${row.trad}</div>
          </div>
          <div class="writers-wrap"><div class="writers"></div></div>
          <div class="pinyin-row">
            <button class="play-main" type="button" data-text="${row.simp}">
              <span class="pinyin-text">${row.pinyin}</span>
            </button>
          </div>
          <div class="meaning">${row.meaning}</div>`;
        const grid=card.querySelector('.writers');
        grid.innerHTML = chars.map(ch=>`<div class="writer" data-char="${ch}" role="button" aria-label="tap"></div>`).join('');
        layoutWritersGrid(grid, chars.length);
        frag2.appendChild(card);
      }
      cardsEl.appendChild(frag2);
      cardsEl.querySelectorAll('.play-main').forEach(btn=>{
        if(!btn.dataset.bound){ btn.dataset.bound='1'; btn.addEventListener('click', e=> speak(e.currentTarget.dataset.text)); }
      });
      cardsEl.querySelectorAll('.writer').forEach(tile=>{
        if(!tile.dataset.observe){ tile.dataset.observe='1'; tileObserver.observe(tile); }
      });
      VISIBLE = end;
    }
  };
}

/* ===== import/paste ===== */
function loadIndex(){try{return JSON.parse(localStorage.getItem(LSK_INDEX)||'[]')}catch{return []}}
function saveIndexLS(a){localStorage.setItem(LSK_INDEX,JSON.stringify(a))}
function dsKey(title){const base=(title||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,64)||('ds-'+Date.now())}
function saveDatasetLS(title,rows){const idx=loadIndex();let key=dsKey(title);while(idx.some(x=>x.key===key))key+='-1';idx.push({key,title});saveIndexLS(idx);localStorage.setItem(LSK_DATA_PREFIX+key,JSON.stringify(rows||[]));return key}
function loadDatasetLS(key){try{return JSON.parse(localStorage.getItem(LSK_DATA_PREFIX+key)||'[]')}catch{return []}}
function deleteDatasetByKeyLS(key){saveIndexLS(loadIndex().filter(x=>x.key!==key));localStorage.removeItem(LSK_DATA_PREFIX+key)}
function refreshDatasetSelect(selectKey){
  const idx=loadIndex(); datasetSel.innerHTML='';
  idx.forEach(d=>{const o=document.createElement('option');o.value=d.key;o.textContent=d.title;datasetSel.appendChild(o)});
  if(selectKey && idx.some(x=>x.key===selectKey)) datasetSel.value=selectKey;
}
loadFileBtn.addEventListener('click', async ()=>{
  const f=fileInput.files&&fileInput.files[0]; if(!f){setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå');return;}
  const title=(dsNameFile.value||f.name||'Imported').trim(); if(!title){setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î');return;}
  const text=await f.text();
  try{
    const rows=parseHSK(text);
    const key=saveDatasetLS(title, rows);
    localStorage.setItem(LSK_LAST,key);
    refreshDatasetSelect(key);
    q.value=''; currentInitial=''; document.querySelectorAll('.alpha button').forEach(x=>x.classList.remove('active'));
    datasetSel.dispatchEvent(new Event('change'));
    setStatus('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß: '+rows.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚úî');
  }catch(e){ setStatus('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e.message); }
});
savePasteBtn.addEventListener('click', ()=>{
  const title=(dsNamePaste.value||'Pasted').trim(); const text=pasteArea.value||'';
  if(!title){setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î');return;}
  if(!text.trim()){setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°');return;}
  try{
    const rows=parseHSK(text);
    const key=saveDatasetLS(title, rows);
    localStorage.setItem(LSK_LAST,key);
    refreshDatasetSelect(key);
    q.value=''; currentInitial=''; document.querySelectorAll('.alpha button').forEach(x=>x.classList.remove('active'));
    datasetSel.dispatchEvent(new Event('change'));
    setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: '+rows.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚úî');
  }catch(e){ setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e.message); }
});
deleteBtn.addEventListener('click', ()=>{
  const key=datasetSel.value; if(!key){setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î');return;}
  const idx=loadIndex(); const ds=idx.find(x=>x.key===key); if(!ds){setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∏‡∏î');return;}
  if(!confirm('‡∏•‡∏ö‡∏ä‡∏∏‡∏î "'+ds.title+'"?')) return;
  deleteDatasetByKeyLS(key); refreshDatasetSelect();
  if(datasetSel.options.length){datasetSel.selectedIndex=0; datasetSel.dispatchEvent(new Event('change')); }
  else { CURRENT=[]; cardsEl.innerHTML=''; }
  setStatus('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
});

/* ===== init ===== */
datasetSel.addEventListener('change', ()=>{
  const key=datasetSel.value; localStorage.setItem(LSK_LAST,key);
  q.value=''; currentInitial=''; document.querySelectorAll('.alpha button').forEach(x=>x.classList.remove('active'));
  CURRENT=loadDatasetLS(key)||[]; render();
});
(function init(){
  let idx=loadIndex();
  if(!idx.length){ refreshDatasetSelect(); }
  else{
    const last=localStorage.getItem(LSK_LAST);
    if(last) refreshDatasetSelect(last); else refreshDatasetSelect(idx[0]?.key);
  }
  if(datasetSel.value) datasetSel.dispatchEvent(new Event('change'));
  if('speechSynthesis'in window){loadVoices(); speechSynthesis.onvoiceschanged=loadVoices}
})();
</script>
</body>
</html>